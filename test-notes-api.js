// Test de l'API des notes avec authentification int√©gr√©e
const fetch = (...args) => import('node-fetch').then(({default: fetch}) => fetch(...args));
const fs = require('fs');

// Configuration
const API_URL = 'http://localhost:3001/api/v1';
const FRONTEND_URL = 'http://localhost:8082';

// Utilisateur de test
const testUser = {
  email: 'Antoineronold@proton.me',
  password: 'Antoineronold@proton.me'
};

// Variable pour stocker les cookies de session
let sessionCookies = [];

// Variable pour stocker le token JWT extrait des cookies
let jwtToken = null;

// Fonction d'authentification pour obtenir les cookies
async function authenticate() {
  console.log('üîë Authentification en cours...');
  
  try {
    const loginResponse = await fetch(`${API_URL}/auth/login`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Origin': FRONTEND_URL
      },
      body: JSON.stringify({
        email: testUser.email,
        password: testUser.password
      }),
      redirect: 'manual',
      credentials: 'include'
    });
    
    console.log(`Status: ${loginResponse.status}`);
    
    // R√©cup√©rer les cookies de la r√©ponse
    sessionCookies = loginResponse.headers.raw()['set-cookie'] || [];
    
    if (sessionCookies.length > 0) {
      console.log(`‚úÖ Authentification r√©ussie, ${sessionCookies.length} cookies re√ßus`);
      
      // Afficher les cookies pour d√©bogage
      sessionCookies.forEach((cookie, index) => {
        console.log(`Cookie ${index + 1}:`, cookie);
      });
      
      // Extraire le token JWT du cookie d'acc√®s
      const accessCookie = sessionCookies.find(cookie => cookie.startsWith('hydia_sess_access='));
      if (accessCookie) {
        jwtToken = accessCookie.split('=')[1].split(';')[0];
        console.log('Token JWT extrait:', jwtToken.substring(0, 20) + '...');
      }
      
      return true;
    } else {
      console.log('‚ùå Authentification √©chou√©e: aucun cookie re√ßu');
      return false;
    }
  } catch (error) {
    console.error('‚ùå Erreur lors de l\'authentification:', error);
    return false;
  }
}

// Fonction utilitaire pour les requ√™tes API avec cookies d'authentification
async function apiRequest(endpoint, method = 'GET', body = null) {
  console.log(`üì° Envoi requ√™te ${method} ${endpoint}`);
  
  const options = {
    method,
    headers: {
      'Content-Type': 'application/json',
      'Origin': FRONTEND_URL
    },
    credentials: 'include'
  };
  
  // Ne pas utiliser les cookies pour ce test, uniquement l'en-t√™te Authorization
  console.log('‚ö†Ô∏è Test sans cookies, uniquement avec l\'en-t√™te Authorization');
  // Comment√© pour tester uniquement avec Authorization
  /*
  if (sessionCookies.length > 0) {
    // Extraire uniquement la partie nom=valeur de chaque cookie
    const simpleCookies = sessionCookies.map(cookie => {
      const cookiePart = cookie.split(';')[0].trim();
      return cookiePart;
    });
    
    options.headers['Cookie'] = simpleCookies.join('; ');
    console.log('üç™ Cookies utilis√©s pour l\'authentification');
    console.log('En-t√™te Cookie simplifi√©:', options.headers['Cookie']);
  }
  */
  
  // Ajouter l'en-t√™te Authorization avec le token JWT
  if (jwtToken) {
    options.headers['Authorization'] = `Bearer ${jwtToken}`;
    console.log('üìù En-t√™te Authorization ajout√© avec le token JWT');
  }
  
  if (body) {
    options.body = JSON.stringify(body);
    console.log('Body:', JSON.stringify(body));
  }
  
  try {
    console.log(`URL compl√®te: ${API_URL}${endpoint}`);
    console.log('En-t√™tes:', JSON.stringify(options.headers));
    
    const response = await fetch(`${API_URL}${endpoint}`, options);
    console.log(`Status: ${response.status}`);
    
    const contentType = response.headers.get('content-type');
    if (contentType && contentType.includes('application/json')) {
      const data = await response.json();
      console.log('R√©ponse:', JSON.stringify(data).substring(0, 200) + '...');
      return {
        status: response.status,
        data,
        success: response.ok
      };
    } else {
      const text = await response.text();
      console.log('R√©ponse (texte):', text.substring(0, 200) + '...');
      return {
        status: response.status,
        data: { text },
        success: response.ok
      };
    }
  } catch (error) {
    console.error(`‚ùå Erreur lors de la requ√™te ${method} ${endpoint}:`, error);
    return {
      status: 500,
      data: { error: error.message },
      success: false
    };
  }
}

// Tests pour les routes de notes
async function testNoteRoutes() {
  console.log('\n=== TESTS DES ROUTES API DE NOTES ===');
  
  let createdNoteId;
  let createdCategoryId;
  let organizationId;

  // 1. R√©cup√©rer l'ID de l'organisation
  console.log('\n1. R√©cup√©ration des organisations...');
  const orgsResponse = await apiRequest('/organizations');
  
  if (orgsResponse.success && orgsResponse.data.organizations && orgsResponse.data.organizations.length > 0) {
    organizationId = orgsResponse.data.organizations[0].id;
    console.log(`‚úÖ Organisation trouv√©e: ${organizationId}`);
  } else {
    console.log('‚ùå Aucune organisation trouv√©e');
    return;
  }

  // 2. Cr√©er une cat√©gorie de note
  console.log('\n2. Cr√©ation d\'une cat√©gorie de note...');
  const categoryData = {
    name: `Test Note Category ${Date.now()}`,
    description: 'Cat√©gorie de notes cr√©√©e pour les tests API'
  };
  
  const createCategoryResponse = await apiRequest(`/organizations/${organizationId}/note-categories`, 'POST', categoryData);
  
  if (createCategoryResponse.success && createCategoryResponse.data.category) {
    createdCategoryId = createCategoryResponse.data.category.id;
    console.log(`‚úÖ Cat√©gorie cr√©√©e: ${createdCategoryId}`);
  } else {
    console.log('‚ùå √âchec de la cr√©ation de la cat√©gorie:', createCategoryResponse.data);
  }

  // 3. R√©cup√©rer les cat√©gories
  console.log('\n3. R√©cup√©ration des cat√©gories...');
  const categoriesResponse = await apiRequest(`/organizations/${organizationId}/note-categories`);
  
  if (categoriesResponse.success) {
    console.log(`‚úÖ ${categoriesResponse.data.categories.length} cat√©gories r√©cup√©r√©es`);
  } else {
    console.log('‚ùå √âchec de la r√©cup√©ration des cat√©gories:', categoriesResponse.data);
  }

  // 4. Cr√©er une note
  console.log('\n4. Cr√©ation d\'une note...');
  const noteData = {
    title: `Test Note ${Date.now()}`,
    content: 'Ceci est une note de test cr√©√©e via l\'API',
    tags: ['test', 'api', 'supabase'],
    isPublic: true,
    categoryId: createdCategoryId
  };
  
  const createNoteResponse = await apiRequest(`/organizations/${organizationId}/notes`, 'POST', noteData);
  
  if (createNoteResponse.success && createNoteResponse.data.note) {
    createdNoteId = createNoteResponse.data.note.id;
    console.log(`‚úÖ Note cr√©√©e: ${createdNoteId}`);
  } else {
    console.log('‚ùå √âchec de la cr√©ation de la note:', createNoteResponse.data);
    return;
  }

  // 5. R√©cup√©rer toutes les notes
  console.log('\n5. R√©cup√©ration de toutes les notes...');
  const notesResponse = await apiRequest(`/organizations/${organizationId}/notes`);
  
  if (notesResponse.success) {
    console.log(`‚úÖ ${notesResponse.data.notes.length} notes r√©cup√©r√©es`);
  } else {
    console.log('‚ùå √âchec de la r√©cup√©ration des notes:', notesResponse.data);
  }

  // 6. R√©cup√©rer une note par ID
  console.log(`\n6. R√©cup√©ration de la note ${createdNoteId}...`);
  const noteResponse = await apiRequest(`/organizations/${organizationId}/notes/${createdNoteId}`);
  
  if (noteResponse.success && noteResponse.data.note) {
    console.log(`‚úÖ Note r√©cup√©r√©e: ${noteResponse.data.note.title}`);
  } else {
    console.log('‚ùå √âchec de la r√©cup√©ration de la note:', noteResponse.data);
  }

  // 7. Mettre √† jour une note
  console.log(`\n7. Mise √† jour de la note ${createdNoteId}...`);
  const updateData = {
    title: `Updated Note ${Date.now()}`,
    content: 'Contenu mis √† jour pour les tests',
    tags: ['test', 'api', 'updated']
  };
  
  const updateResponse = await apiRequest(`/organizations/${organizationId}/notes/${createdNoteId}`, 'PUT', updateData);
  
  if (updateResponse.success && updateResponse.data.note) {
    console.log(`‚úÖ Note mise √† jour: ${updateResponse.data.note.title}`);
  } else {
    console.log('‚ùå √âchec de la mise √† jour de la note:', updateResponse.data);
  }

  // 8. Rechercher des notes
  console.log('\n8. Recherche de notes...');
  const searchTerm = 'Test';
  const searchResponse = await apiRequest(`/organizations/${organizationId}/notes/search?search=${searchTerm}`);
  
  if (searchResponse.success) {
    console.log(`‚úÖ ${searchResponse.data.notes.length} r√©sultats trouv√©s pour "${searchTerm}"`);
  } else {
    console.log('‚ùå √âchec de la recherche:', searchResponse.data);
  }

  // 9. Rechercher des notes par tags
  console.log('\n9. Recherche de notes par tags...');
  const tagSearchResponse = await apiRequest(`/organizations/${organizationId}/notes/by-tags?tags=test,api`);
  
  if (tagSearchResponse.success) {
    console.log(`‚úÖ ${tagSearchResponse.data.notes.length} notes trouv√©es avec les tags sp√©cifi√©s`);
  } else {
    console.log('‚ùå √âchec de la recherche par tags:', tagSearchResponse.data);
  }

  // 10. Obtenir les statistiques des notes
  console.log('\n10. R√©cup√©ration des statistiques des notes...');
  const statsResponse = await apiRequest(`/organizations/${organizationId}/notes/stats`);
  
  if (statsResponse.success && statsResponse.data.stats) {
    console.log(`‚úÖ Statistiques r√©cup√©r√©es: ${statsResponse.data.stats.totalNotes} notes au total`);
  } else {
    console.log('‚ùå √âchec de la r√©cup√©ration des statistiques:', statsResponse.data);
  }

  // 11. Dupliquer une note
  console.log(`\n11. Duplication de la note ${createdNoteId}...`);
  const duplicateResponse = await apiRequest(`/organizations/${organizationId}/notes/${createdNoteId}/duplicate`, 'POST');
  
  if (duplicateResponse.success && duplicateResponse.data.note) {
    console.log(`‚úÖ Note dupliqu√©e: ${duplicateResponse.data.note.title}`);
    // Supprimer la note dupliqu√©e pour nettoyer
    const duplicatedNoteId = duplicateResponse.data.note.id;
    await apiRequest(`/organizations/${organizationId}/notes/${duplicatedNoteId}`, 'DELETE');
  } else {
    console.log('‚ùå √âchec de la duplication de la note:', duplicateResponse.data);
  }

  // 12. Exporter les notes
  console.log('\n12. Export des notes...');
  const exportResponse = await apiRequest(`/organizations/${organizationId}/notes/export`);
  
  if (exportResponse.success && exportResponse.data.notes) {
    console.log(`‚úÖ ${exportResponse.data.notes.length} notes export√©es`);
  } else {
    console.log('‚ùå √âchec de l\'export:', exportResponse.data);
  }

  // 13. Supprimer une note
  console.log(`\n13. Suppression de la note ${createdNoteId}...`);
  const deleteResponse = await apiRequest(`/organizations/${organizationId}/notes/${createdNoteId}`, 'DELETE');
  
  if (deleteResponse.success) {
    console.log('‚úÖ Note supprim√©e avec succ√®s');
  } else {
    console.log('‚ùå √âchec de la suppression de la note:', deleteResponse.data);
  }

  console.log('\n=== TESTS TERMIN√âS ===');
};


// Fonction principale qui ex√©cute l'authentification puis les tests
async function runTests() {
  console.log('=== TEST DE L\'API DES NOTES AVEC AUTHENTIFICATION INT√âGR√âE ===');
  
  // 1. Authentification pour obtenir les cookies
  const authSuccess = await authenticate();
  
  if (authSuccess) {
    console.log('\n‚úÖ Authentification r√©ussie, ex√©cution des tests de notes...');
    await testNoteRoutes();
    console.log('\n=== TESTS TERMIN√âS ===');
  } else {
    console.log('\n‚ùå √âchec de l\'authentification, tests de notes annul√©s.');
  }
}

// Ex√©cuter les tests
runTests().catch(error => {
  console.error('\n‚ùå Erreur lors de l\'ex√©cution des tests:', error);
});
